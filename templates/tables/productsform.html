{% load i18n %}

{% if productsform %}
<div class="row">
    <form method="post" id="products_form">
        {% csrf_token %}
        {{ productsform.management_form }}
        {{ productsform.non_form_errors }}
        <table class="table table-hover">
            <thead class="table-secondary">
                <tr>
                    <th scope="col">{% trans 'Product' %}</th>
                    <th scope="col">{% trans 'Count' %}</th>
                    <th scope="col">{% trans 'Use price' %}</th>
                    <th scope="col">{% trans 'Netto price' %}</th>
                    <th scope="col">{% trans 'VAT' %}</th>
                    <th scope="col">{% trans 'Brutto price' %}</th>
                    <th scope="col">{% trans 'Delete' %}</th>
                </tr>
            </thead>
            <tbody id="products_form-tbody">
                {% for line in productsform %}
                    {{ line.id }}
                    <tr id="row-{{ forloop.counter0 }}">
                        <th>{{ line.product }}</th>
                        <th>{{ line.count }}</th>
                        <th>{{ line.use_product_price }}</th>
                        <th>{{ line.amount_netto_positiv }}</th>
                        <th>{{ line.vat }}</th>
                        <th>{{ line.amount_brutto_positiv }}</th>
                        <th>
                            {% if forloop.counter0 < productsform|length %}
                            <input type="hidden" name="products-{{ forloop.counter0 }}-DELETE"
                                   id="id_products-{{ forloop.counter0 }}-DELETE">
                            <button type="button" class="btn-close" onclick="deleteProduct({{ forloop.counter0 }});"
                                    id="id_products-{{ forloop.counter0 }}-delete-button"
                                    aria-label="{% trans 'close' %}">
                            </button>
                            {% endif %}
                        </th>
                    </tr>
                {% endfor %}
                {% with productsform.empty_form as line %}
                    <tr id="products_form-empty_row">
                        <th>{{ line.product }}</th>
                        <th>{{ line.count }}</th>
                        <th>{{ line.use_product_price }}</th>
                        <th>{{ line.amount_netto_positiv }}</th>
                        <th>{{ line.vat }}</th>
                        <th>{{ line.amount_brutto_positiv }}</th>
                        <th></th>
                    </tr>
                {% endwith %}
            </tbody>
        </table>
        <button type="button" class="btn btn-outline-secondary mt-2 mb-3 me-2" id="add_product_button"
                onclick="addProduct();">{% translate "Add product" %}
        </button>
        <button type="submit" class="btn btn-secondary mt-2 mb-3" name="editProducts" value="editProducts"
                id="products_form_button">{% translate "Save" %}
        </button>
    </form>
</div>
<script>
    function addProduct() {
        const count = new Number(document.getElementById("id_products-TOTAL_FORMS").value);
        const copyRow = document.getElementById("products_form-empty_row").cloneNode(true);
        copyRow.setAttribute('class', 'table-success');
        copyRow.setAttribute('id', 'row-'+ count);
        const regexp = new RegExp('__prefix__', 'g');
        copyRow.innerHTML = copyRow.innerHTML.replace(regexp, count);
        document.getElementById("products_form-tbody").append(copyRow);
        document.getElementById("id_products-TOTAL_FORMS").value = count + 1;
    }
</script>
{% endif %}